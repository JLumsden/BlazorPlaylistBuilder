@page "/editspotifylist/{setlistId}"
@using ActualPlaylistBuilder.Models
@using ActualPlaylistBuilder.Models.TrackSearch
@using Components.Shared

@inject ISetlistService SetlistService
@inject ISpotifySearchService SpotifySearchService

@* @foreach(var item in searchTerms)
{
    <MudPaper>@item</MudPaper>
} *@
<MudToolBar Fixed="true" Color="Color.Primary" Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" />
    <MudTextField @bind-Value="playlistDetails.name" HelperText="Playlist Name"/>
    <MudTextField @bind-Value="playlistDetails.description" HelperText="Playlist Description"/>
    <MudSpacer />
    <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" Edge="Edge.End" OnClick="SubmitPlaylist"/>
</MudToolBar>

@if(!string.IsNullOrEmpty(playlistUri))
{
    <MudText>@playlistUri</MudText>
}


    @foreach (var track in giggities)
    {

        @if (track.Tracks.Items is not null && track.Tracks.Items.Any())
        {
    <div class="justify-content-center"><SongPicker Items="@track.Tracks.Items" /></div>
            
            
        }

    }
    


@code {
    [Parameter]
    public string setlistId { get; set; }
    public List<string> searchTerms { get; set; }
    public List<SongSearch> giggities { get; set; } = new();
    public string bloop { get; set; }
    [Inject]
    private ISpotifyAuthService spotifyAuthService { get; set; }
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public PlaylistDetails playlistDetails { get; set; } = new();
    public string playlistUri { get; set; } = string.Empty;

    private int selectedIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        searchTerms = SetlistService.GetSearchList();
        Console.WriteLine("GetTrack");
        await GetTrack("Periphery Chvrch Bvrner");
        await GetTrack("Periphery Reptile");

        // foreach(var term in searchTerms)
        // {
        //     await GetTrack(term);
        // }
    }

    private async Task GetTrack(string term)
    {
        SongSearch? tempVal;
        tempVal = await SpotifySearchService.GetTrack(term);
        if (tempVal is not null)
        {
            giggities.Add(tempVal);
            StateHasChanged();
        }
        else
        {
            Console.WriteLine(term + " failed");
        }
    }

    public async Task SubmitPlaylist()
    {
        playlistUri = await spotifyAuthService.OrchestratePlaylist(playlistDetails, giggities.Select(g => g.Tracks).Select(t => t.Items[0].Uri).ToList());
    }
}
